# usage : launcher [-i|--interactive|-a|--automatic] image [database_path]
#!/bin/sh

usage="No similar image found (no comparison could be performed successfully)."

mode=""
image=""
database_path=""

key=$1
if [ -z "$key" ]; then
    echo $usage
    exit 0
fi

case $key in 
    -i|--interactive )
        mode="interactiv"
        shift
        ;;
    -a|--automatic )
        mode="automatic"
        shift
        ;;
    *)
        echo $usage
        exit 1
esac

if [ -f "$1" ]; then
    image="$1"
else 
    # echo $usage
    # exit 2
    echo "OK"
fi

dossier=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
export PATH="$dossier/img-dist:$PATH"


if [ "$mode" = "automatic" ] && [ -d "$2" ]; then
    database_path="$2/"
    # echo "lancement du mode auto, sur le fichier $image et avec la db $database_path"
    ./list-file.sh $database_path | ./img-search "$image"
elif [ "$mode" = "automatic" ] && [ -z "$2" ]; then
    database_path="./img/"
    # echo "lancement du mode auto, sur le fichier $image et avec la db $database_path"
    ./list-file.sh $database_path | ./img-search "$image"


elif [ "$mode" = "interactiv" ]; then
    # echo "lancement du mode interactiv, sur le fichier $image et avec passage par d√©faut des fichiers depuis la le path $database_path"
    
    if [ -d "$2" ]; then
        database_path="$2/"
    fi

    if [ -t 0 ]; then
    while true; do
        read input
        if [ "$input" = "exit" ]; then
            break
        fi
        echo "$database_path$input"
    done | ./img-search "$image"
    
    else
        # Input is being piped
        while read input; do
            echo "$database_path$input"
        done | ./img-search "$image"
    fi

fi

    

    
